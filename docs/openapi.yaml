openapi: 3.0.1
info:
  title: RepoBackend API
  description: API para gestión de inventario y ventas (productos, stock, carritos,
    facturas, talleres, favoritos)
  contact:
    name: Equipo RepoBackend
    email: devs@example.com
  license:
    name: Proprietary
  version: 0.0.1
servers:
- url: /
  description: Servidor local / producción (configurable)
security:
- bearerAuth: []
tags:
- name: Facturas
  description: Creación y consulta de facturas con IVA y descuento de stock
- name: Auth
  description: Autenticación y gestión de tokens
- name: Favoritos
  description: Operaciones para gestionar productos favoritos del usuario
- name: AdminUsers
  description: Creación de administradores
- name: Talleres
  description: Administración de talleres, almacenes e invitaciones
- name: Configuración Global
  description: Endpoints para gestionar la configuración del sistema (IVA, datos de
    empresa, resolución DIAN, etc.)
- name: TallerMiembros
  description: Operaciones sobre miembros de taller (promover, demover, remover)
- name: Categorias
  description: Gestión de categorías de productos
- name: Stock
  description: Operaciones para gestionar inventario por almacén
- name: PublicCategoriasController
  description: Endpoints públicos de categorías (sin autenticación)
- name: Productos
  description: Operaciones para gestionar productos
- name: Carritos
  description: Operaciones sobre carritos de compra
- name: Movimientos
  description: Registro de entradas y salidas de stock
- name: PublicProductosController
  description: Endpoints públicos de productos (sin autenticación)
- name: Uploads
  description: Operaciones relacionadas con uploads a Cloudinary
paths:
  /api/talleres/{tallerId}:
    get:
      tags:
      - Talleres
      summary: Obtener taller
      description: Obtiene información del taller por id
      operationId: getTaller
      parameters:
      - name: tallerId
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Taller encontrado
        '404':
          description: No encontrado
    put:
      tags:
      - Talleres
      summary: Actualizar taller
      description: Actualiza datos del taller (solo nombre por ahora)
      operationId: actualizarTaller
      parameters:
      - name: tallerId
        in: path
        required: true
        schema:
          type: string
      requestBody:
        description: Datos a actualizar
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TallerRequest'
            example:
              nombre: Nuevo Nombre
        required: true
      responses:
        '200':
          description: Taller actualizado
        '404':
          description: No encontrado
        '403':
          description: Permisos insuficientes
    delete:
      tags:
      - Talleres
      summary: Eliminar taller
      description: Elimina permanentemente el taller y todos sus almacenes asociados.
        Solo el owner puede hacerlo. Esta acción no se puede deshacer.
      operationId: eliminarTaller
      parameters:
      - name: tallerId
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Taller eliminado
        '403':
          description: Permisos insuficientes
        '404':
          description: No encontrado
  /api/talleres/{tallerId}/almacenes/{almacenId}:
    get:
      tags:
      - Talleres
      summary: Obtener almacén
      description: Obtiene un almacén por id
      operationId: getAlmacen
      parameters:
      - name: tallerId
        in: path
        required: true
        schema:
          type: string
      - name: almacenId
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Almacén encontrado
        '404':
          description: No encontrado
    put:
      tags:
      - Talleres
      summary: Actualizar almacén
      description: Actualiza un almacén (nombre/ubicacion). Requiere owner o ADMIN.
      operationId: actualizarAlmacen
      parameters:
      - name: tallerId
        in: path
        required: true
        schema:
          type: string
      - name: almacenId
        in: path
        required: true
        schema:
          type: string
      requestBody:
        description: Datos de almacén
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AlmacenRequest'
            example:
              nombre: Almacén Nuevo
              ubicacion: Calle 1
        required: true
      responses:
        '200':
          description: Almacén actualizado
        '403':
          description: Permisos insuficientes
        '404':
          description: No encontrado
    delete:
      tags:
      - Talleres
      summary: Eliminar almacén
      description: Elimina permanentemente un almacén. Requiere owner o ADMIN. Esta
        acción no se puede deshacer.
      operationId: eliminarAlmacen
      parameters:
      - name: tallerId
        in: path
        required: true
        schema:
          type: string
      - name: almacenId
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Almacén eliminado
        '403':
          description: Permisos insuficientes
        '404':
          description: No encontrado
  /api/productos/{id}:
    get:
      tags:
      - Productos
      summary: Obtener producto por ID
      description: 'Devuelve los detalles completos de un producto.


        **La respuesta incluye:**

        - Datos básicos (nombre, descripción, precio, stock)

        - **tasaIva**: Tasa de IVA en porcentaje (usado para calcular IVA en facturas)

        - `listaMedios`: Array con imágenes (cada una con publicId, secure_url, etc.)

        - `specs`: Objeto con especificaciones técnicas (si existen)

        - `tallerId`: ID del taller propietario (si existe)

        - `categoriaId`: ID de la categoría (si existe)

        '
      operationId: getProducto_1
      parameters:
      - name: id
        in: path
        description: ID del producto
        required: true
        schema:
          type: string
        example: 507f191e810c19729de860ea
      responses:
        '200':
          description: Producto encontrado
          content:
            application/json:
              example:
                producto:
                  id: 507f191e810c19729de860ea
                  nombre: Filtro de Aceite Yamaha
                  descripcion: Filtro de aceite para motos Yamaha 150cc
                  precio: 25000
                  tasaIva: 19.0
                  stock: 100
                  categoriaId: 507f1f77bcf86cd799439011
                  tallerId: 507f1f77bcf86cd799439777
                  listaMedios:
                  - type: image/jpeg
                    publicId: products/507f1f77/filtro-yamaha-abc123
                    secure_url: https://res.cloudinary.com/df7ggzasi/image/upload/v1763285023/products/507f1f77/filtro-yamaha-abc123.jpg
                    format: jpg
                    width: 800
                    height: 600
                    order: 0
                  specs:
                    Marca: Yamaha
                    Modelo: YZF-R15
                    Compatibilidad: 150cc
                    Material: Papel
                    Peso: 0.2kg
        '404':
          description: Producto no encontrado
    put:
      tags:
      - Productos
      summary: Actualizar producto
      description: 'Actualiza los datos del producto. Envía solo los campos que deseas
        actualizar.


        **IMPORTANTE sobre `listaMedios`:**

        - Si actualizas `listaMedios`, DEBE incluir `publicId` en cada medio

        - Al actualizar, se reemplazan las imágenes anteriores (las viejas se eliminan
        de Cloudinary automáticamente)

        - Para agregar nuevas imágenes manteniendo las existentes, primero obtén el
        producto actual y agrega a su array


        **Nota sobre `specs`:**

        - Al actualizar `specs`, se reemplaza el objeto completo (no se hace merge)

        - Para actualizar una sola especificación, envía el objeto completo con el
        cambio

        '
      operationId: actualizarProducto
      parameters:
      - name: id
        in: path
        description: ID del producto
        required: true
        schema:
          type: string
        example: 507f191e810c19729de860ea
      requestBody:
        description: 'Datos actualizados del producto (solo enviar los campos a modificar).

          Si actualizas `listaMedios`, DEBE incluir `publicId` en cada elemento.

          '
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductoRequest'
            examples:
              Actualizar datos básicos:
                description: Actualizar datos básicos
                value:
                  nombre: Filtro de Aceite Yamaha R15
                  precio: 27.0
                  stock: 150
              Actualizar con nueva imagen:
                description: Actualizar con nueva imagen
                value:
                  nombre: Filtro de Aceite Yamaha R15
                  listaMedios:
                  - type: image/jpeg
                    publicId: products/nuevo-filtro-xyz789
                    secure_url: https://res.cloudinary.com/df7ggzasi/image/upload/v1763285500/products/nuevo-filtro-xyz789.jpg
                    format: jpg
                    order: 0
        required: true
      responses:
        '200':
          description: Producto actualizado exitosamente
          content:
            application/json:
              example:
                producto:
                  id: 507f191e810c19729de860ea
                  nombre: Filtro de Aceite Yamaha R15
                  precio: 27.0
        '404':
          description: Producto no encontrado
        '400':
          description: Datos inválidos
    delete:
      tags:
      - Productos
      summary: Eliminar producto
      description: 'Elimina un producto por ID. **IMPORTANTE**: También elimina automáticamente
        las imágenes asociadas de Cloudinary (si existen en `listaMedios`).'
      operationId: eliminar
      parameters:
      - name: id
        in: path
        description: ID del producto a eliminar
        required: true
        schema:
          type: string
        example: 507f191e810c19729de860ea
      responses:
        '200':
          description: Producto eliminado exitosamente (y sus medios de Cloudinary)
          content:
            application/json:
              example:
                deleted: true
        '404':
          description: Producto no encontrado
        '403':
          description: Sin permisos para eliminar este producto
  /api/categorias/{id}:
    get:
      tags:
      - Categorias
      summary: Obtener categoría por ID
      description: 'Devuelve los detalles completos de una categoría.


        **La respuesta incluye:**

        - Datos básicos (nombre, descripción)

        - `tallerId`: ID del taller propietario

        - `listaMedios`: Array con imágenes (cada una con publicId, secure_url, etc.)

        - `mappedGlobalCategoryId`: ID de categoría global (si existe)


        **Nota:** Este endpoint es público (no requiere autenticación)

        '
      operationId: getCategoria_1
      parameters:
      - name: id
        in: path
        description: ID de la categoría
        required: true
        schema:
          type: string
        example: 507f1f77bcf86cd799439011
      responses:
        '200':
          description: Categoría encontrada
          content:
            application/json:
              example:
                categoria:
                  id: 507f1f77bcf86cd799439011
                  nombre: Filtros
                  descripcion: Filtros de aceite, aire y combustible
                  tallerId: 507f1f77bcf86cd799439777
                  listaMedios:
                  - type: image/jpeg
                    publicId: products/507f1f77/categoria-filtros-abc123
                    secure_url: https://res.cloudinary.com/df7ggzasi/image/upload/v1763282466/products/507f1f77/categoria-filtros-abc123.jpg
                    format: jpg
                    width: 800
                    height: 600
                    order: 0
                  mappedGlobalCategoryId: global-cat-filtros
        '404':
          description: Categoría no encontrada
    put:
      tags:
      - Categorias
      summary: Actualizar categoría
      description: 'Actualiza los datos de una categoría. Envía solo los campos que
        deseas actualizar.


        **IMPORTANTE sobre `listaMedios`:**

        - Si actualizas `listaMedios`, DEBE incluir `publicId` en cada medio

        - Al actualizar, se reemplazan las imágenes anteriores (las viejas se eliminan
        de Cloudinary automáticamente)

        - Para agregar nuevas imágenes manteniendo las existentes, primero obtén la
        categoría actual y agrega a su array


        **Campos actualizables:**

        - `nombre`: Nombre de la categoría

        - `descripcion`: Descripción

        - `tallerId`: ID del taller (normalmente no se cambia)

        - `listaMedios`: Array de medios (DEBE incluir publicId)

        - `mappedGlobalCategoryId`: ID de categoría global

        '
      operationId: actualizarCategoria
      parameters:
      - name: id
        in: path
        description: ID de la categoría
        required: true
        schema:
          type: string
        example: 507f1f77bcf86cd799439011
      requestBody:
        description: 'Datos actualizados de la categoría (solo enviar los campos a
          modificar).

          Si actualizas `listaMedios`, DEBE incluir `publicId` en cada elemento.

          '
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CategoriaRequest'
            examples:
              Actualizar nombre y descripción:
                description: Actualizar nombre y descripción
                value:
                  nombre: Filtros Premium
                  descripcion: Filtros de alta calidad para motos
              Actualizar con nueva imagen:
                description: Actualizar con nueva imagen
                value:
                  nombre: Filtros Premium
                  listaMedios:
                  - type: image/jpeg
                    publicId: products/nueva-categoria-xyz789
                    secure_url: https://res.cloudinary.com/df7ggzasi/image/upload/v1763285500/products/nueva-categoria-xyz789.jpg
                    format: jpg
                    order: 0
        required: true
      responses:
        '200':
          description: Categoría actualizada exitosamente
          content:
            application/json:
              example:
                categoria:
                  id: 507f1f77bcf86cd799439011
                  nombre: Filtros Premium
                  descripcion: Filtros de alta calidad para motos
        '404':
          description: Categoría no encontrada
        '400':
          description: Datos inválidos
    delete:
      tags:
      - Categorias
      summary: Eliminar categoría
      description: 'Elimina una categoría por ID.


        **IMPORTANTE:**

        - También elimina automáticamente las imágenes asociadas de Cloudinary (si
        existen en `listaMedios` con `publicId`)

        - Si la categoría tiene productos asociados, puede fallar (dependiendo de
        la lógica de negocio)

        - Esta acción no se puede deshacer


        **Limpieza automática:**

        - Todas las imágenes en `listaMedios` que tengan `publicId` serán eliminadas
        de Cloudinary

        - Si alguna imagen no tiene `publicId`, quedará huérfana en Cloudinary

        '
      operationId: eliminar_1
      parameters:
      - name: id
        in: path
        description: ID de la categoría a eliminar
        required: true
        schema:
          type: string
        example: 507f1f77bcf86cd799439011
      responses:
        '200':
          description: Categoría eliminada exitosamente (y sus medios de Cloudinary)
          content:
            application/json:
              example:
                deleted: true
                id: 507f1f77bcf86cd799439011
        '404':
          description: Categoría no encontrada
        '403':
          description: Sin permisos para eliminar esta categoría
  /api/uploads/cloudinary-sign:
    post:
      tags:
      - Uploads
      summary: Generar firma para Cloudinary
      description: Genera apiKey, timestamp y signature para permitir uploads firmados
        desde el cliente. El body opcional puede incluir parámetros a firmar como
        'folder' o 'public_id'.
      operationId: sign
      responses:
        '200':
          description: OK
          content:
            '*/*':
              schema:
                type: object
  /api/talleres:
    get:
      tags:
      - Talleres
      summary: Listar talleres propios
      description: Lista los talleres donde el usuario es owner
      operationId: listMyTalleres
      responses:
        '200':
          description: Lista de talleres
    post:
      tags:
      - Talleres
      summary: Crear taller
      description: Crea un taller y lo asocia al usuario autenticado como propietario
        (owner)
      operationId: crearTaller
      requestBody:
        description: Datos del taller
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TallerRequest'
            examples:
              Nuevo taller:
                description: Nuevo taller
                value:
                  nombre: Taller Motos del Norte
        required: true
      responses:
        '201':
          description: Taller creado exitosamente
          content:
            application/json:
              example:
                taller:
                  id: 507f1f77bcf86cd799439777
                  nombre: Taller Motos del Norte
                  ownerId: 507f1f77bcf86cd799439011
        '401':
          description: Usuario no autenticado
  /api/talleres/{tallerId}/miembros/{memberUserId}/promote:
    post:
      tags:
      - TallerMiembros
      summary: Promover miembro a ADMIN
      description: Otorga permisos de administrador a un miembro del taller. Solo
        puede hacerlo el owner o un miembro ADMIN.
      operationId: promote
      parameters:
      - name: tallerId
        in: path
        description: ID del taller
        required: true
        schema:
          type: string
        example: 507f1f77bcf86cd799439777
      - name: memberUserId
        in: path
        description: ID del usuario a promover
        required: true
        schema:
          type: string
        example: 507f1f77bcf86cd799439011
      responses:
        '200':
          description: Miembro promovido exitosamente
          content:
            application/json:
              example:
                success: true
                userId: 507f1f77bcf86cd799439011
                newRole: ADMIN
                message: Usuario promovido a ADMIN
        '401':
          description: Usuario no autenticado
        '403':
          description: No tienes permisos para esta operación
        '404':
          description: Taller o miembro no encontrado
  /api/talleres/{tallerId}/miembros/{memberUserId}/demote:
    post:
      tags:
      - TallerMiembros
      summary: Demover miembro (remover rol ADMIN)
      description: Remueve los permisos de administrador a un miembro del taller.
        Solo puede hacerlo el owner.
      operationId: demote
      parameters:
      - name: tallerId
        in: path
        description: ID del taller
        required: true
        schema:
          type: string
        example: 507f1f77bcf86cd799439777
      - name: memberUserId
        in: path
        description: ID del usuario a demover
        required: true
        schema:
          type: string
        example: 507f1f77bcf86cd799439011
      responses:
        '200':
          description: Miembro demovido exitosamente
          content:
            application/json:
              example:
                success: true
                userId: 507f1f77bcf86cd799439011
                newRole: VENDEDOR
                message: Permisos de ADMIN removidos
        '401':
          description: Usuario no autenticado
        '403':
          description: No tienes permisos para esta operación
        '404':
          description: Taller o miembro no encontrado
  /api/talleres/{tallerId}/invitaciones/codigo:
    post:
      tags:
      - Talleres
      summary: Crear invitación por código
      description: 'Genera un código de invitación para que usuarios puedan unirse
        a un taller. Roles disponibles: VENDEDOR, ADMIN.'
      operationId: crearInvitacionCodigo
      parameters:
      - name: tallerId
        in: path
        description: ID del taller
        required: true
        schema:
          type: string
        example: 507f1f77bcf86cd799439777
      requestBody:
        description: Configuración de la invitación
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: object
            examples:
              Invitación de vendedor:
                description: Invitación de vendedor
                value:
                  role: VENDEDOR
                  daysValid: 7
              Invitación de admin:
                description: Invitación de admin
                value:
                  role: ADMIN
                  daysValid: 30
        required: true
      responses:
        '201':
          description: Invitación creada exitosamente
          content:
            application/json:
              example:
                invitacion:
                  code: TALLER-ABC123XYZ
                  role: VENDEDOR
                  expiresAt: '2024-11-06T10:30:00Z'
        '401':
          description: Usuario no autenticado
  /api/talleres/{tallerId}/almacenes:
    get:
      tags:
      - Talleres
      summary: Listar almacenes de un taller
      description: Devuelve los almacenes asociados a un taller
      operationId: listarAlmacenes
      parameters:
      - name: tallerId
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Lista de almacenes
        '404':
          description: Taller no encontrado
    post:
      tags:
      - Talleres
      summary: Crear almacén en taller
      description: Crea un almacén dentro de un taller existente. Solo el owner o
        administradores del taller pueden crear almacenes.
      operationId: crearAlmacen
      parameters:
      - name: tallerId
        in: path
        description: ID del taller
        required: true
        schema:
          type: string
        example: 507f1f77bcf86cd799439777
      requestBody:
        description: Datos del almacén
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: string
            examples:
              Nuevo almacén:
                description: Nuevo almacén
                value:
                  nombre: Almacén Principal
                  ubicacion: Calle 123, Local 5
        required: true
      responses:
        '201':
          description: Almacén creado exitosamente
          content:
            application/json:
              example:
                almacen:
                  id: 507faaa1bcf86cd799439011
                  nombre: Almacén Principal
                  ubicacion: Calle 123, Local 5
                  tallerId: 507f1f77bcf86cd799439777
        '401':
          description: Usuario no autenticado
  /api/talleres/invitaciones/accept:
    post:
      tags:
      - Talleres
      summary: Aceptar invitación por código
      description: Permite a un usuario autenticado unirse a un taller usando un código
        de invitación válido
      operationId: acceptInvitacion
      requestBody:
        description: Código de invitación
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: string
            examples:
              Aceptar invitación:
                description: Aceptar invitación
                value:
                  code: TALLER-ABC123XYZ
        required: true
      responses:
        '200':
          description: Invitación aceptada exitosamente
          content:
            application/json:
              example:
                success: true
                tallerId: 507f1f77bcf86cd799439777
                role: VENDEDOR
                message: Te has unido al taller exitosamente
        '400':
          description: Código inválido o expirado
        '401':
          description: Usuario no autenticado
  /api/stock/set:
    post:
      tags:
      - Stock
      summary: Setear stock
      description: Establece la cantidad exacta de stock en un almacén específico
        (reemplaza el valor anterior)
      operationId: set
      requestBody:
        description: Cantidad exacta a establecer
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: object
            examples:
              Establecer stock:
                description: Establecer stock
                value:
                  productoId: 507f191e810c19729de860ea
                  almacenId: 507faaa1bcf86cd799439011
                  cantidad: 100
        required: true
      responses:
        '200':
          description: Stock establecido exitosamente
          content:
            application/json:
              example:
                success: true
                cantidad: 100
        '400':
          description: Datos inválidos
  /api/stock/adjust:
    post:
      tags:
      - Stock
      summary: Ajustar stock (delta)
      description: Aumenta o disminuye el stock en un almacén específico. Use valores
        positivos para aumentar y negativos para disminuir.
      operationId: adjust
      requestBody:
        description: Datos del ajuste
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: object
            examples:
              Aumentar stock:
                description: Aumentar stock
                value:
                  productoId: 507f191e810c19729de860ea
                  almacenId: 507faaa1bcf86cd799439011
                  delta: 50
              Disminuir stock:
                description: Disminuir stock
                value:
                  productoId: 507f191e810c19729de860ea
                  almacenId: 507faaa1bcf86cd799439011
                  delta: -10
        required: true
      responses:
        '200':
          description: Stock ajustado exitosamente
          content:
            application/json:
              example:
                success: true
                nuevaCantidad: 140
        '400':
          description: Datos inválidos
  /api/productos:
    get:
      tags:
      - Productos
      summary: Listar productos
      description: Devuelve una lista paginada de productos. Soporta búsqueda por
        nombre (q) o filtrado por categoría (categoriaId).
      operationId: listar_1
      parameters:
      - name: q
        in: query
        description: Búsqueda por nombre de producto
        required: false
        schema:
          type: string
        example: filtro
      - name: categoriaId
        in: query
        description: ID de la categoría para filtrar
        required: false
        schema:
          type: string
        example: 507f1f77bcf86cd799439011
      - name: tallerId
        in: query
        description: ID del taller/tienda para filtrar productos por tienda
        schema:
          type: string
        example: 507f1f77bcf86cd799439777
      - name: page
        in: query
        description: Número de página (base 0)
        required: false
        schema:
          type: integer
          format: int32
          default: 0
        example: 0
      - name: size
        in: query
        description: Cantidad de elementos por página
        required: false
        schema:
          type: integer
          format: int32
          default: 20
        example: 20
      responses:
        '200':
          description: Lista de productos paginada
          content:
            application/json:
              example:
                content:
                - id: 507f191e810c19729de860ea
                  nombre: Filtro de Aceite
                  precio: 25.5
                page: 0
                size: 20
                totalElements: 45
                totalPages: 3
    post:
      tags:
      - Productos
      summary: Crear producto
      description: 'Crea un nuevo producto en el inventario.


        **NUEVO (v2.0): Campo tasaIva obligatorio para facturación**

        - `tasaIva`: Tasa de IVA en porcentaje (ej: 0, 5, 19). **Default: 19%** si
        no se especifica

        - Este campo es usado automáticamente al generar facturas para calcular el
        IVA

        - Valores comunes en Colombia: 0% (exento), 5% (canasta básica), 19% (estándar)


        **IMPORTANTE - Gestión de Imágenes:**

        - Las imágenes DEBEN subirse primero a Cloudinary usando `/api/uploads/cloudinary-sign`

        - Cada objeto en `listaMedios` DEBE incluir el campo `publicId` (CRÍTICO para
        eliminar imágenes al borrar el producto)

        - Sin `publicId`, las imágenes quedarán huérfanas en Cloudinary y no se podrán
        eliminar automáticamente


        **Campos recomendados:**

        - `tallerId`: Asocia el producto a un taller específico (recomendado para
        multi-tenant)

        - `specs`: Mapa de especificaciones técnicas (ej: {"Marca":"Yamaha", "Modelo":"R15",
        "Peso":"0.2kg"})

        - `listaMedios`: Array de objetos con estructura: {type, publicId, secure_url,
        format, width, height, order}


        **Flujo recomendado para imágenes:**

        1. Obtener firma: POST /api/uploads/cloudinary-sign con {folder: "products"}

        2. Subir a Cloudinary con la firma obtenida

        3. Guardar en `listaMedios` el objeto completo que devuelve Cloudinary (especialmente
        `public_id`)

        '
      operationId: crearProducto
      requestBody:
        description: 'Datos del producto.

          **NUEVO**: Campo `tasaIva` (IVA en %) - Si no se envía, se asigna 19% por
          defecto.

          **CRÍTICO**: Si incluyes `listaMedios`, cada medio DEBE tener `publicId`
          para poder eliminar las imágenes de Cloudinary.

          El campo `specs` es opcional pero recomendado para especificaciones técnicas.

          '
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductoRequest'
            examples:
              Ejemplo de producto completo con IVA:
                description: Ejemplo de producto completo con IVA
                value:
                  nombre: Filtro de Aceite Yamaha
                  descripcion: Filtro de aceite para motos Yamaha 150cc
                  precio: 25000
                  tasaIva: 19.0
                  stock: 100
                  categoriaId: 507f1f77bcf86cd799439011
                  tallerId: 507f1f77bcf86cd799439777
                  listaMedios:
                  - type: image/jpeg
                    publicId: products/507f1f77/filtro-yamaha-abc123
                    secure_url: https://res.cloudinary.com/df7ggzasi/image/upload/v1763285023/products/507f1f77/filtro-yamaha-abc123.jpg
                    url: https://res.cloudinary.com/df7ggzasi/image/upload/v1763285023/products/507f1f77/filtro-yamaha-abc123.jpg
                    format: jpg
                    width: 800
                    height: 600
                    order: 0
                  specs:
                    Marca: Yamaha
                    Modelo: YZF-R15
                    Compatibilidad: 150cc
                    Material: Papel
                    Peso: 0.2kg
        required: true
      responses:
        '201':
          description: Producto creado exitosamente
          content:
            application/json:
              example:
                producto:
                  id: 507f191e810c19729de860ea
                  nombre: Filtro de Aceite Yamaha
                  precio: 25000
                  tasaIva: 19.0
                  stock: 100
                  tallerId: 507f1f77bcf86cd799439777
        '400':
          description: 'Datos inválidos (ej: nombre vacío, stock negativo)'
  /api/movimientos:
    get:
      tags:
      - Movimientos
      summary: Listar movimientos
      description: Lista movimientos de stock. Puede filtrarse por producto o por
        tipo de movimiento.
      operationId: listar_2
      parameters:
      - name: productoId
        in: query
        description: ID del producto para filtrar
        required: false
        schema:
          type: string
        example: 507f191e810c19729de860ea
      - name: tipo
        in: query
        description: Tipo de movimiento (INGRESO, EGRESO, VENTA, DEVOLUCION, AJUSTE)
        required: false
        schema:
          type: string
        example: INGRESO
      responses:
        '200':
          description: Lista de movimientos
          content:
            application/json:
              example:
                movimientos:
                - id: 507f191e810c19729de860eb
                  tipo: INGRESO
                  productoId: 507f191e810c19729de860ea
                  cantidad: 50
                  fecha: '2024-10-30T10:30:00Z'
    post:
      tags:
      - Movimientos
      summary: Crear movimiento
      description: 'Registra una entrada (INGRESO) o salida (EGRESO) de stock. Los
        tipos válidos son: INGRESO, EGRESO, VENTA, DEVOLUCION, AJUSTE.'
      operationId: crearMovimiento
      requestBody:
        description: Datos del movimiento
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MovimientoRequest'
            examples:
              Ingreso de mercancía:
                description: Ingreso de mercancía
                value:
                  tipo: INGRESO
                  productoId: 507f191e810c19729de860ea
                  cantidad: 50
                  referencia: OC-2024-001
                  notas: Compra a proveedor
                  realizadoPor: 507f1f77bcf86cd799439011
              Egreso por venta:
                description: Egreso por venta
                value:
                  tipo: VENTA
                  productoId: 507f191e810c19729de860ea
                  cantidad: 5
                  referencia: FAC-2024-123
                  notas: Venta cliente ABC
        required: true
      responses:
        '201':
          description: Movimiento creado exitosamente
          content:
            application/json:
              example:
                movimiento:
                  id: 507f191e810c19729de860eb
                  tipo: INGRESO
                  productoId: 507f191e810c19729de860ea
                  cantidad: 50
                  fecha: '2024-10-30T10:30:00Z'
        '400':
          description: Datos inválidos
  /api/favoritos/productos/{productoId}:
    post:
      tags:
      - Favoritos
      summary: Agregar producto a favoritos
      description: Añade un producto a la lista de favoritos del usuario autenticado
      operationId: add
      parameters:
      - name: productoId
        in: path
        description: ID del producto a agregar
        required: true
        schema:
          type: string
        example: 507f191e810c19729de860ea
      responses:
        '201':
          description: Favorito creado exitosamente
          content:
            application/json:
              example:
                favorito:
                  id: 507fabc123def456789012ab
                  productoId: 507f191e810c19729de860ea
                  usuarioId: 507f1f77bcf86cd799439011
                  fechaCreacion: '2024-10-30T10:30:00Z'
        '400':
          description: Solicitud inválida
        '401':
          description: Usuario no autenticado
        '404':
          description: Producto no encontrado
    delete:
      tags:
      - Favoritos
      summary: Remover producto de favoritos
      description: Remueve un producto de la lista de favoritos del usuario autenticado
      operationId: remove_1
      parameters:
      - name: productoId
        in: path
        description: ID del producto a remover
        required: true
        schema:
          type: string
        example: 507f191e810c19729de860ea
      responses:
        '200':
          description: Favorito removido exitosamente
          content:
            application/json:
              example:
                exito: true
                mensaje: Producto removido de favoritos
        '401':
          description: Usuario no autenticado
  /api/facturas:
    get:
      tags:
      - Facturas
      summary: Listar facturas por usuario
      operationId: listarPorUsuario
      parameters:
      - name: userId
        in: query
        required: false
        schema:
          type: string
      responses:
        '200':
          description: Lista de facturas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Factura'
    post:
      tags:
      - Facturas
      summary: Crear factura EMITIDA
      description: Crea y emite una factura definitiva. SIEMPRE descuenta stock y
        calcula precios/IVA desde productos. No acepta precios del cliente.
      operationId: crearFactura
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FacturaRequest'
        required: true
      responses:
        '500':
          description: Error interno
        '201':
          description: Factura creada y emitida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Factura'
        '409':
          description: Conflicto (p.ej. stock insuficiente)
        '400':
          description: Datos inválidos
  /api/facturas/{id}/emitir:
    post:
      tags:
      - Facturas
      summary: Emitir borrador
      description: Emite un borrador (descuenta stock y cambia estado a EMITIDA)
      operationId: emitirBorrador
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '404':
          description: Borrador no encontrado
        '500':
          description: Error interno
        '200':
          description: Borrador emitido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Factura'
        '409':
          description: Conflicto al emitir
  /api/facturas/{id}/anular:
    post:
      tags:
      - Facturas
      summary: Anular factura
      description: Anula una factura emitida (NO devuelve stock automáticamente)
      operationId: anularFactura
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '500':
          description: Error interno
        '200':
          description: Factura anulada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Factura'
        '404':
          description: Factura no encontrada
        '409':
          description: No se puede anular
  /api/facturas/checkout:
    post:
      tags:
      - Facturas
      summary: Checkout carrito
      description: Crea factura EMITIDA desde carrito. SIEMPRE descuenta stock y calcula
        precios/IVA desde productos.
      operationId: checkout
      requestBody:
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: object
        required: true
      responses:
        '409':
          description: Conflicto (stock)
        '500':
          description: Error interno
        '401':
          description: No autenticado
        '201':
          description: Factura creada desde carrito
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Factura'
        '400':
          description: Datos inválidos
  /api/facturas/borrador:
    post:
      tags:
      - Facturas
      summary: Crear factura en BORRADOR
      description: Crea factura sin descontar stock (para cotizaciones). Usar POST
        /facturas/{id}/emitir para emitirla.
      operationId: crearBorrador
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FacturaRequest'
        required: true
      responses:
        '201':
          description: Borrador creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Factura'
        '500':
          description: Error interno
        '400':
          description: Datos inválidos
  /api/configuracion:
    get:
      tags:
      - Configuración Global
      summary: Obtener configuración global
      description: 'Obtiene la configuración global del sistema, incluyendo:

        - **tasaIvaPorDefecto**: Tasa de IVA por defecto para productos nuevos (%)

        - **Datos de empresa**: nombre, NIT, dirección, teléfono, etc.

        - **Resolución DIAN**: prefijo, número de resolución, rango autorizado


        Si no existe configuración, se crea automáticamente con valores por defecto
        (IVA 19%).


        **Uso en Frontend**: El valor de `tasaIvaPorDefecto` se debe usar al crear
        nuevos productos

        y puede ser modificado desde el panel de configuración por un ADMIN.

        '
      operationId: obtenerConfiguracion
      responses:
        '200':
          description: Configuración obtenida exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfiguracionGlobalResponse'
              example:
                id: 507f191e810c19729de860ea
                tasaIvaPorDefecto: 19.0
                nombreEmpresa: Repuestos ABC S.A.S
                nit: '900123456'
                digitoVerificacion: '7'
                direccion: 'Calle 123 #45-67'
                telefono: '3001234567'
                email: contacto@repuestos.com
                ciudad: Bogotá
                departamento: Cundinamarca
                prefijoFactura: FV
                resolucionDian: '18764123456789'
                rangoFacturaInicio: 1
                rangoFacturaFin: 5000
                proximoNumeroFactura: 1
                actualizadoEn: '2025-01-17T10:30:00'
        '401':
          description: No autenticado
          content:
            '*/*':
              schema:
                $ref: '#/components/schemas/ConfiguracionGlobalResponse'
        '403':
          description: No autorizado (requiere rol ADMIN)
          content:
            '*/*':
              schema:
                $ref: '#/components/schemas/ConfiguracionGlobalResponse'
      security:
      - bearerAuth: []
    post:
      tags:
      - Configuración Global
      summary: Actualizar configuración global
      description: 'Actualiza la configuración global del sistema.

        Solo se actualizan los campos enviados (permite actualización parcial).


        **Casos de uso principales**:

        - Cambiar tasa de IVA por defecto cuando cambie la legislación colombiana

        - Configurar datos de la empresa para facturas

        - Configurar resolución DIAN para facturación electrónica


        **IMPORTANTE**: El cambio de `tasaIvaPorDefecto` NO afecta productos existentes,

        solo se aplica a productos creados después del cambio.

        '
      operationId: actualizarConfiguracion
      requestBody:
        description: Campos a actualizar (todos opcionales)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfiguracionGlobalRequest'
            examples:
              Cambiar IVA:
                description: 'Ejemplo: Cambiar IVA de 19% a 21%'
                value:
                  tasaIvaPorDefecto: 21.0
              Configuración completa:
                description: Configuración completa
                value:
                  tasaIvaPorDefecto: 19.0
                  nombreEmpresa: Repuestos ABC S.A.S
                  nit: '900123456'
                  digitoVerificacion: '7'
                  direccion: 'Calle 123 #45-67'
                  telefono: '3001234567'
                  email: contacto@repuestos.com
                  ciudad: Bogotá
                  departamento: Cundinamarca
                  prefijoFactura: FV
                  resolucionDian: '18764123456789'
                  rangoFacturaInicio: 1
                  rangoFacturaFin: 5000
        required: true
      responses:
        '200':
          description: Configuración actualizada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfiguracionGlobalResponse'
        '401':
          description: No autenticado
          content:
            '*/*':
              schema:
                $ref: '#/components/schemas/ConfiguracionGlobalResponse'
        '403':
          description: No autorizado (requiere rol ADMIN)
          content:
            '*/*':
              schema:
                $ref: '#/components/schemas/ConfiguracionGlobalResponse'
      security:
      - bearerAuth: []
  /api/categorias:
    get:
      tags:
      - Categorias
      summary: Buscar/listar categorías
      description: Busca categorías por nombre o lista categorías de un taller. Por
        defecto `tallerId` es obligatorio; usar `todas=true` sólo si se es platform-admin
        para obtener todas las categorías.
      operationId: listar_3
      parameters:
      - name: q
        in: query
        description: Término de búsqueda para nombre de categoría
        required: false
        schema:
          type: string
        example: filtro
      - name: page
        in: query
        description: Número de página
        required: false
        schema:
          type: integer
          format: int32
          default: 0
        example: 0
      - name: size
        in: query
        description: Elementos por página
        required: false
        schema:
          type: integer
          format: int32
          default: 20
        example: 20
      - name: tallerId
        in: query
        description: ID del taller (obligatorio para listar)
        required: true
        schema:
          type: string
        example: 507f1f77bcf86cd799439777
      - name: todas
        in: query
        description: Si true y el caller es platform-admin devuelve todas las categorías
        required: false
        schema:
          type: boolean
          default: false
        example: false
      responses:
        '200':
          description: Lista de categorías
          content:
            application/json:
              example:
                categorias:
                - id: 507f1f77bcf86cd799439011
                  nombre: Filtros
                  tallerId: 507f1f77bcf86cd799439777
                  listaMedios:
                  - publicId: products/507f1f77/abc123
                    secure_url: https://res.cloudinary.com/...
                total: 1
    post:
      tags:
      - Categorias
      summary: Crear categoría
      description: 'Crea una nueva categoría de productos.


        **IMPORTANTE:**

        - `tallerId` es REQUERIDO para crear categorías (validación en el servicio)

        - Si no se proporciona `tallerId`, el backend devolverá: {"error": "tallerId
        es obligatorio para crear una categoría"}


        **Gestión de Imágenes:**

        - Las imágenes DEBEN subirse primero a Cloudinary usando `/api/uploads/cloudinary-sign`

        - Cada objeto en `listaMedios` DEBE incluir el campo `publicId` (CRÍTICO para
        eliminar imágenes al borrar la categoría)

        - Sin `publicId`, las imágenes quedarán huérfanas en Cloudinary y no se podrán
        eliminar automáticamente


        **Estructura de `listaMedios`:**

        - Cada elemento debe tener: {type, publicId, secure_url, format, width, height,
        order}

        - El campo `publicId` es retornado por Cloudinary como `public_id` al subir
        la imagen


        **Flujo recomendado para imágenes:**

        1. Obtener firma: POST /api/uploads/cloudinary-sign con {folder: "products"}

        2. Subir a Cloudinary con la firma obtenida

        3. Guardar en `listaMedios` el objeto completo que devuelve Cloudinary (especialmente
        `public_id`)

        '
      operationId: crearCategoria
      requestBody:
        description: 'Datos de la categoría.

          **REQUERIDO**: `nombre` y `tallerId` (el backend validará que `tallerId`
          esté presente)

          **CRÍTICO**: Si incluyes `listaMedios`, cada medio DEBE tener `publicId`
          para poder eliminar las imágenes de Cloudinary.

          '
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CategoriaRequest'
            examples:
              Ejemplo de categoría completa:
                description: Ejemplo de categoría completa
                value:
                  nombre: Filtros
                  descripcion: Filtros de aceite, aire y combustible
                  tallerId: 507f1f77bcf86cd799439777
                  listaMedios:
                  - type: image/jpeg
                    publicId: products/507f1f77/categoria-filtros-abc123
                    secure_url: https://res.cloudinary.com/df7ggzasi/image/upload/v1763282466/products/507f1f77/categoria-filtros-abc123.jpg
                    url: https://res.cloudinary.com/df7ggzasi/image/upload/v1763282466/products/507f1f77/categoria-filtros-abc123.jpg
                    format: jpg
                    width: 800
                    height: 600
                    order: 0
                  mappedGlobalCategoryId: global-cat-filtros
        required: true
      responses:
        '201':
          description: Categoría creada exitosamente
          content:
            application/json:
              example:
                categoria:
                  id: 507f1f77bcf86cd799439011
                  nombre: Filtros
                  descripcion: Filtros de aceite, aire y combustible
                  tallerId: 507f1f77bcf86cd799439777
                  listaMedios:
                  - type: image/jpeg
                    publicId: products/507f1f77/categoria-filtros-abc123
                    secure_url: https://res.cloudinary.com/df7ggzasi/image/upload/v1763282466/products/507f1f77/categoria-filtros-abc123.jpg
        '400':
          description: 'Datos inválidos (ej: falta tallerId, nombre vacío, o error
            de validación)'
          content:
            application/json:
              example:
                error: tallerId es obligatorio para crear una categoría
        '403':
          description: Permisos insuficientes
          content:
            application/json:
              example:
                error: Permisos insuficientes para crear categoría en este taller
  /api/carritos:
    get:
      tags:
      - Carritos
      summary: Listar carritos por usuario
      description: Devuelve los carritos asociados a un usuario
      operationId: listarPorUsuario_1
      parameters:
      - name: usuarioId
        in: query
        required: false
        schema:
          type: string
      responses:
        '200':
          description: Lista de carritos
    post:
      tags:
      - Carritos
      summary: Crear carrito
      description: Crea un carrito nuevo para un usuario o anónimo. Si se omite usuarioId,
        crea un carrito anónimo que puede sincronizarse después del login.
      operationId: crear
      requestBody:
        description: Datos del carrito
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CarritoRequest'
            examples:
              Carrito con items:
                description: Carrito con items
                value:
                  usuarioId: 507f1f77bcf86cd799439011
                  items:
                  - productoId: 507f191e810c19729de860ea
                    cantidad: 2
                    precioUnitario: 25.5
              Carrito anónimo vacío:
                description: Carrito anónimo vacío
                value:
                  items: []
        required: true
      responses:
        '201':
          description: Carrito creado exitosamente
          content:
            application/json:
              example:
                carrito:
                  id: 507f1f77bcf86cd799439999
                  usuarioId: 507f1f77bcf86cd799439011
                  items: []
                  total: 0.0
        '400':
          description: Datos inválidos
  /api/carritos/{id}/items:
    post:
      tags:
      - Carritos
      summary: Agregar item a carrito
      description: Agrega un producto al carrito del usuario autenticado. Si el producto
        ya existe, actualiza la cantidad.
      operationId: addItem
      parameters:
      - name: id
        in: path
        description: ID del carrito
        required: true
        schema:
          type: string
        example: 507f1f77bcf86cd799439999
      requestBody:
        description: Item a agregar
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CarritoItemRequest'
            examples:
              Item de carrito:
                description: Item de carrito
                value:
                  productoId: 507f191e810c19729de860ea
                  cantidad: 2
                  precioUnitario: 25.5
        required: true
      responses:
        '200':
          description: Item agregado exitosamente
          content:
            application/json:
              example:
                carrito:
                  id: 507f1f77bcf86cd799439999
                  items:
                  - productoId: 507f191e810c19729de860ea
                    cantidad: 2
                  total: 51.0
        '401':
          description: Usuario no autenticado
        '403':
          description: No tienes permisos para modificar este carrito
        '404':
          description: Carrito no encontrado
  /api/carritos/{id}/clear:
    post:
      tags:
      - Carritos
      summary: Vaciar carrito
      description: Elimina todos los items del carrito
      operationId: clear
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Carrito vaciado
  /api/carritos/merge:
    post:
      tags:
      - Carritos
      summary: Merge de carrito anónimo
      description: Sincroniza un carrito anónimo al usuario autenticado tras el login.
        Combina items del carrito anónimo con el carrito del usuario.
      operationId: merge
      requestBody:
        description: ID del carrito anónimo y/o items a sincronizar
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: object
            examples:
              Merge de carrito:
                description: Merge de carrito
                value:
                  anonCartId: 507f1f77bcf86cd799439888
                  items:
                  - productoId: 507f191e810c19729de860ea
                    cantidad: 3
                    precioUnitario: 25.5
        required: true
      responses:
        '200':
          description: Merge realizado exitosamente
          content:
            application/json:
              example:
                merged: true
                carritoId: 507f1f77bcf86cd799439999
                totalItems: 5
        '401':
          description: Usuario no autenticado
  /api/auth/revoke-all:
    post:
      tags:
      - Auth
      summary: Revocar todos los refresh tokens
      description: Revoca todos los refresh tokens del usuario autenticado
      operationId: revokeAll
      responses:
        '200':
          description: Revocado
  /api/auth/register:
    post:
      tags:
      - Auth
      summary: Registro de usuario
      description: Registra un usuario nuevo en el sistema. Opcionalmente puede incluir
        un código de invitación para unirse a un taller.
      operationId: register
      requestBody:
        description: Datos del nuevo usuario
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
            examples:
              Ejemplo de registro:
                description: Ejemplo de registro
                value:
                  username: jperez
                  email: jperez@example.com
                  password: securePass123
                  nombre: Juan
                  apellido: Pérez
                  inviteCode: ABC123
        required: true
      responses:
        '200':
          description: Usuario creado exitosamente
          content:
            application/json:
              example:
                message: Usuario registrado exitosamente
                userId: 507f1f77bcf86cd799439011
        '400':
          description: Datos inválidos o usuario ya existe
  /api/auth/refresh:
    post:
      tags:
      - Auth
      summary: Refresh token
      description: Renueva el token de acceso usando un refresh token válido
      operationId: refresh
      requestBody:
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: string
            example:
              refreshToken: r1234567890abcdef
        required: true
      responses:
        '200':
          description: Tokens renovados
          content:
            application/json:
              example:
                accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                refreshToken: r9876543210fedcba
        '401':
          description: Refresh token inválido o expirado
  /api/auth/oauth/google:
    post:
      tags:
      - Auth
      summary: OAuth Google
      description: Autenticación/registro usando Google OAuth. Requiere el idToken
        obtenido del flujo OAuth de Google.
      operationId: oauthGoogle
      requestBody:
        description: Token de Google y datos opcionales
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: string
            examples:
              Login con Google:
                description: Login con Google
                value:
                  idToken: eyJhbGciOiJSUzI1NiIsImtpZCI6IjAx...
                  inviteCode: TALLER-ABC123
                  device: android
        required: true
      responses:
        '200':
          description: OAuth exitoso
          content:
            application/json:
              example:
                accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                refreshToken: r1234567890
                user:
                  id: 507f1f77bcf86cd799439011
                  email: user@gmail.com
        '400':
          description: Token de Google inválido
  /api/auth/logout:
    post:
      tags:
      - Auth
      summary: Logout
      description: Revoca el refresh token dado
      operationId: logout
      requestBody:
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: string
        required: true
      responses:
        '200':
          description: Logout realizado
  /api/auth/login:
    post:
      tags:
      - Auth
      summary: Login
      description: Inicia sesión con username/email y contraseña. Devuelve tokens
        JWT de acceso y refresh.
      operationId: login
      requestBody:
        description: Credenciales de acceso
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            examples:
              Ejemplo de login:
                description: Ejemplo de login
                value:
                  usernameOrEmail: jperez
                  password: securePass123
                  device: web
        required: true
      responses:
        '200':
          description: Login exitoso
          content:
            application/json:
              examples:
                Respuesta exitosa:
                  description: Respuesta exitosa
                  value:
                    accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    refreshToken: r1234567890abcdef
                    user:
                      id: 507f1f77bcf86cd799439011
                      username: jperez
                      email: jperez@example.com
        '401':
          description: Credenciales inválidas
  /api/admin/users:
    post:
      tags:
      - AdminUsers
      summary: Crear administrador
      description: Crea un nuevo usuario con rol de administrador. Solo puede ser
        ejecutado por usuarios que ya son administradores.
      operationId: createAdmin
      requestBody:
        description: Datos del nuevo administrador
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAdminRequest'
            examples:
              Crear admin:
                description: Crear admin
                value:
                  username: admin.sistemas
                  email: admin@empresa.com
                  password: SecurePass123!
                  nombre: Juan
                  apellido: Administrador
        required: true
      responses:
        '201':
          description: Administrador creado exitosamente
          content:
            application/json:
              example:
                userId: 507f1f77bcf86cd799439011
                username: admin.sistemas
                email: admin@empresa.com
                role: ADMIN
                message: Administrador creado exitosamente
        '400':
          description: Datos inválidos o usuario ya existe
        '403':
          description: No tienes permisos para crear administradores
  /api/productos/{id}/stock:
    patch:
      tags:
      - Productos
      summary: Ajustar stock de producto
      description: Ajusta el stock del producto sumando o restando una cantidad (delta).
        Usa valores positivos para aumentar y negativos para disminuir.
      operationId: ajustarStock
      parameters:
      - name: id
        in: path
        description: ID del producto
        required: true
        schema:
          type: string
        example: 507f191e810c19729de860ea
      requestBody:
        description: Delta de ajuste de stock
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: object
            example:
              delta: 10
        required: true
      responses:
        '200':
          description: Stock ajustado exitosamente
          content:
            application/json:
              example:
                producto:
                  id: 507f191e810c19729de860ea
                  stock: 110
        '404':
          description: Producto no encontrado
  /api/talleres/{tallerId}/miembros:
    get:
      tags:
      - Talleres
      summary: Listar miembros del taller
      description: Devuelve los miembros de un taller (userId, roles, joinedAt). Requiere
        que el usuario autenticado pertenezca al taller.
      operationId: listarMiembros
      parameters:
      - name: tallerId
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Lista de miembros
        '401':
          description: No autenticado
        '403':
          description: No eres miembro del taller
        '404':
          description: Taller no encontrado
  /api/talleres/_debug:
    get:
      tags:
      - Talleres
      summary: 'DEBUG: listar talleres por userId (temporal)'
      description: 'Endpoint temporal para depuración: pasar ?userId=<id> para simular
        autenticación y devolver talleres para ese userId. Eliminar/proteger en producción.'
      operationId: debugListByUser
      parameters:
      - name: userId
        in: query
        required: false
        schema:
          type: string
      responses:
        '200':
          description: Debug info
  /api/stock:
    get:
      tags:
      - Stock
      summary: Obtener stock por producto
      description: Devuelve el stock disponible de un producto desglosado por almacén
        y el total consolidado. Si se envía almacenId, incluye además la cantidad
        específica en ese almacén.
      operationId: getByProducto
      parameters:
      - name: productoId
        in: query
        description: ID del producto
        required: true
        schema:
          type: string
        example: 507f191e810c19729de860ea
      - name: almacenId
        in: query
        description: ID del almacén (opcional)
        required: false
        schema:
          type: string
        example: 507faaa1bcf86cd799439011
      responses:
        '200':
          description: Stock obtenido exitosamente
          content:
            application/json:
              example:
                stockByAlmacen:
                - almacenId: 507faaa1bcf86cd799439011
                  almacenNombre: Principal
                  cantidad: 50
                - almacenId: 507fbbb1bcf86cd799439012
                  almacenNombre: Sucursal
                  cantidad: 30
                total: 80
    delete:
      tags:
      - Stock
      summary: Eliminar registro de stock
      description: Elimina el registro de stock para producto+almacén
      operationId: delete
      parameters:
      - name: productoId
        in: query
        required: true
        schema:
          type: string
      - name: almacenId
        in: query
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Registro eliminado
        '404':
          description: No encontrado
  /api/stock/{productoId}:
    get:
      tags:
      - Stock
      summary: Obtener stock por producto (ruta alternativa)
      description: Variante con path param para facilitar proxys. Acepta query almacenId
        opcional.
      operationId: getByProductoPath
      parameters:
      - name: productoId
        in: path
        description: ID del producto
        required: true
        schema:
          type: string
        example: 507f191e810c19729de860ea
      - name: almacenId
        in: query
        description: ID del almacén (opcional)
        required: false
        schema:
          type: string
        example: 507faaa1bcf86cd799439011
      responses:
        '200':
          description: OK
          content:
            '*/*':
              schema:
                type: object
  /api/public/productos:
    get:
      tags:
      - PublicProductosController
      summary: Listar productos (público)
      description: 'Devuelve productos paginados para clientes públicos (sin autenticación).


        **NUEVO (v2.0)**: La respuesta ahora incluye `tasaIva` (tasa de IVA en %)
        para cada producto.

        Este campo se usa para calcular el IVA al momento de comprar (checkout).


        Soporta:

        - Búsqueda por nombre con `q`

        - Filtrado por `categoriaId`

        - Paginación con `page` y `size`


        La respuesta expone `totalStock` agregado, `stockByAlmacen` y `tasaIva` cuando
        está disponible.

        '
      operationId: listar
      parameters:
      - name: q
        in: query
        required: false
        schema:
          type: string
      - name: categoriaId
        in: query
        required: false
        schema:
          type: string
      - name: page
        in: query
        required: false
        schema:
          type: integer
          format: int32
          default: 0
      - name: size
        in: query
        required: false
        schema:
          type: integer
          format: int32
          default: 20
      responses:
        '200':
          description: Lista de productos
          content:
            application/json:
              example:
                productos:
                - id: 507f191e810c19729de860ea
                  nombre: Filtro
                  precio: 25000
                  tasaIva: 19.0
                  totalStock: 50
                total: 1
                page: 0
                size: 20
  /api/public/productos/{id}:
    get:
      tags:
      - PublicProductosController
      summary: Obtener producto por ID (público)
      description: 'Devuelve los detalles completos de un producto con `totalStock`
        agregado, `stockByAlmacen` y `tasaIva`.


        **IMPORTANTE para App Android**: El campo `tasaIva` se usa para mostrar el
        precio con IVA incluido

        y calcular el total al agregar al carrito. Ejemplo: precio=$25.000, tasaIva=19%
        → Precio final=$29.750


        Este endpoint no requiere autenticación.

        '
      operationId: getProducto
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Producto encontrado
          content:
            application/json:
              example:
                producto:
                  id: 507f191e810c19729de860ea
                  nombre: Filtro de Aceite
                  precio: 25000
                  tasaIva: 19.0
                  totalStock: 50
                  stockByAlmacen:
                  - almacenId: abc
                    cantidad: 20
        '404':
          description: Producto no encontrado
  /api/public/categorias:
    get:
      tags:
      - PublicCategoriasController
      summary: Listar todas las categorías (público)
      description: 'Devuelve todas las categorías (globales + por taller) sin requerir
        autenticación.

        Este endpoint está diseñado para clientes móviles y aplicaciones públicas.


        **Nota:** No requiere token de autenticación.

        '
      operationId: listarCategorias
      parameters:
      - name: page
        in: query
        description: Número de página
        required: false
        schema:
          type: integer
          format: int32
          default: 0
        example: 0
      - name: size
        in: query
        description: Elementos por página
        required: false
        schema:
          type: integer
          format: int32
          default: 20
        example: 20
      - name: q
        in: query
        description: Búsqueda por nombre (opcional)
        required: false
        schema:
          type: string
        example: filtros
      responses:
        '200':
          description: Lista de categorías
          content:
            application/json:
              example:
                categorias:
                - id: 507f1f77bcf86cd799439011
                  nombre: Filtros
                  tallerId: 507f1f77bcf86cd799439777
                  listaMedios:
                  - publicId: products/507f1f77/abc123
                    secure_url: https://res.cloudinary.com/...
                total: 1
                page: 0
                size: 20
  /api/public/categorias/{id}:
    get:
      tags:
      - PublicCategoriasController
      summary: Obtener categoría por ID (público)
      description: 'Devuelve los detalles de una categoría específica sin requerir
        autenticación.


        **Nota:** No requiere token de autenticación.

        '
      operationId: getCategoria
      parameters:
      - name: id
        in: path
        description: ID de la categoría
        required: true
        schema:
          type: string
        example: 507f1f77bcf86cd799439011
      responses:
        '200':
          description: Categoría encontrada
          content:
            application/json:
              example:
                categoria:
                  id: 507f1f77bcf86cd799439011
                  nombre: Filtros
                  descripcion: Filtros de aceite, aire y combustible
                  tallerId: 507f1f77bcf86cd799439777
                  listaMedios:
                  - type: image/jpeg
                    publicId: products/507f1f77/categoria-filtros-abc123
                    secure_url: https://res.cloudinary.com/...
        '404':
          description: Categoría no encontrada
  /api/movimientos/{id}:
    get:
      tags:
      - Movimientos
      summary: Obtener movimiento por id
      description: Devuelve un movimiento por su id
      operationId: getMovimiento
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Movimiento encontrado
        '404':
          description: Movimiento no encontrado
  /api/favoritos:
    get:
      tags:
      - Favoritos
      summary: Listar favoritos
      description: Devuelve una lista paginada de productos favoritos del usuario
        autenticado
      operationId: list
      parameters:
      - name: page
        in: query
        description: Número de página (base 0)
        required: false
        schema:
          type: integer
          format: int32
          default: 0
        example: 0
      - name: size
        in: query
        description: Elementos por página
        required: false
        schema:
          type: integer
          format: int32
          default: 20
        example: 20
      responses:
        '200':
          description: Lista de favoritos
          content:
            application/json:
              example:
                favoritos:
                - id: 507fabc123def456789012ab
                  productoId: 507f191e810c19729de860ea
                  producto:
                    nombre: Filtro de Aceite
                    precio: 25.5
                page: 0
                size: 20
                total: 5
        '401':
          description: Usuario no autenticado
  /api/favoritos/productos/{productoId}/es-favorito:
    get:
      tags:
      - Favoritos
      summary: Comprobar favorito
      description: Comprueba si un producto está en la lista de favoritos del usuario
        autenticado
      operationId: isFav
      parameters:
      - name: productoId
        in: path
        description: ID del producto a verificar
        required: true
        schema:
          type: string
        example: 507f191e810c19729de860ea
      responses:
        '200':
          description: Estado del favorito
          content:
            application/json:
              example:
                favorito: true
        '401':
          description: Usuario no autenticado
  /api/facturas/{id}:
    get:
      tags:
      - Facturas
      summary: Obtener factura por id
      operationId: getFactura
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Factura encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Factura'
        '404':
          description: Factura no encontrada
    delete:
      tags:
      - Facturas
      summary: Eliminar factura borrador
      description: Elimina una factura en estado BORRADOR (cotización rechazada o
        descartada). Solo se pueden eliminar facturas que NO han sido emitidas.
      operationId: eliminarBorrador
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '500':
          description: Error interno
        '200':
          description: Borrador eliminado exitosamente
          content:
            application/json: {}
        '409':
          description: No se puede eliminar (solo BORRADOR)
        '404':
          description: Factura no encontrada
  /api/facturas/{id}/pdf:
    get:
      tags:
      - Facturas
      summary: Descargar PDF de factura con IVA
      operationId: descargarPdf
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '500':
          description: Error interno
        '200':
          description: PDF de la factura
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        '404':
          description: Factura no encontrada
  /api/facturas/numero/{numero}:
    get:
      tags:
      - Facturas
      summary: Obtener factura por número
      operationId: getPorNumero
      parameters:
      - name: numero
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Factura encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Factura'
        '404':
          description: Factura no encontrada
  /api/configuracion/iva-defecto:
    get:
      tags:
      - Configuración Global
      summary: Obtener tasa de IVA por defecto
      description: 'Obtiene únicamente la tasa de IVA por defecto configurada en el
        sistema.


        **Uso**: Útil para formularios de creación de productos donde se necesita

        pre-cargar el campo de IVA con el valor por defecto.


        Retorna 19.0% si no hay configuración.

        '
      operationId: obtenerIvaDefecto
      responses:
        '200':
          description: Tasa de IVA obtenida
          content:
            application/json:
              example:
                tasaIvaPorDefecto: 19.0
      security:
      - bearerAuth: []
  /api/carritos/{id}:
    get:
      tags:
      - Carritos
      summary: Obtener carrito por ID
      description: Devuelve un carrito por su id
      operationId: getById
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Carrito encontrado
        '404':
          description: Carrito no encontrado
    delete:
      tags:
      - Carritos
      summary: Eliminar carrito
      description: Elimina un carrito por id
      operationId: delete_1
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Carrito eliminado
  /api/auth/me:
    get:
      tags:
      - Auth
      summary: Obtener info del usuario actual
      description: Devuelve datos del usuario autenticado
      operationId: me
      responses:
        '200':
          description: Usuario actual
  /api/talleres/{tallerId}/miembros/{memberUserId}:
    delete:
      tags:
      - TallerMiembros
      summary: Remover miembro del taller
      description: Elimina un miembro del taller. Solo puede hacerlo el owner o un
        ADMIN.
      operationId: remove
      parameters:
      - name: tallerId
        in: path
        description: ID del taller
        required: true
        schema:
          type: string
        example: 507f1f77bcf86cd799439777
      - name: memberUserId
        in: path
        description: ID del usuario a remover
        required: true
        schema:
          type: string
        example: 507f1f77bcf86cd799439011
      responses:
        '200':
          description: Miembro removido exitosamente
          content:
            application/json:
              example:
                success: true
                userId: 507f1f77bcf86cd799439011
                message: Miembro removido del taller
        '401':
          description: Usuario no autenticado
        '403':
          description: No tienes permisos para esta operación
        '404':
          description: Taller o miembro no encontrado
  /api/carritos/{id}/items/{productoId}:
    delete:
      tags:
      - Carritos
      summary: Remover item de carrito
      description: Remueve un item del carrito del usuario autenticado
      operationId: removeItem
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      - name: productoId
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Item removido
components:
  schemas:
    TallerRequest:
      required:
      - nombre
      type: object
      properties:
        nombre:
          type: string
    AlmacenRequest:
      required:
      - nombre
      type: object
      properties:
        nombre:
          type: string
        ubicacion:
          type: string
    ProductoRequest:
      required:
      - nombre
      type: object
      properties:
        idString:
          type: string
        nombre:
          type: string
        descripcion:
          type: string
        precio:
          type: number
          format: double
        tasaIva:
          type: number
          format: double
        stock:
          minimum: 0
          type: integer
          description: 'Stock inicial del producto (opcional). MODO SIMPLE: Si se
            especifica, el stock se almacena directamente en el producto y las facturas
            descuentan de aquí. MODO AVANZADO: Para gestión multi-almacén, crear el
            producto con stock=0 y luego usar POST /api/stock/set para asignar a almacenes
            específicos. El sistema detecta automáticamente qué modo usar al facturar.'
          format: int32
          example: 100
        categoriaId:
          type: string
        listaMedios:
          type: array
          items:
            type: object
            additionalProperties:
              type: object
        specs:
          type: object
          additionalProperties:
            type: string
        tallerId:
          type: string
    CategoriaRequest:
      required:
      - nombre
      type: object
      properties:
        idString:
          type: string
        nombre:
          type: string
        descripcion:
          type: string
        tallerId:
          type: string
        mappedGlobalCategoryId:
          type: string
        listaMedios:
          type: array
          items:
            type: object
            additionalProperties:
              type: object
    MovimientoRequest:
      required:
      - cantidad
      - productoId
      - tipo
      type: object
      properties:
        tipo:
          pattern: (?i)^(INGRESO|EGRESO|VENTA|DEVOLUCION|AJUSTE)$
          type: string
        productoId:
          type: string
        cantidad:
          minimum: 1
          type: integer
          format: int32
        referencia:
          type: string
        notas:
          type: string
        realizadoPor:
          pattern: ^[a-fA-F0-9]{24}$
          type: string
        almacenId:
          pattern: ^[a-fA-F0-9]{24}$
          type: string
    ClienteRequest:
      type: object
      properties:
        nombre:
          type: string
        documento:
          type: string
        direccion:
          type: string
    FacturaItemRequest:
      required:
      - cantidad
      - productoId
      type: object
      properties:
        productoId:
          type: string
          description: ID del producto a facturar
          example: 507f1f77bcf86cd799439011
        cantidad:
          minimum: 1
          type: integer
          description: Cantidad a facturar
          format: int32
          example: 2
      description: Item de la factura. Solo se envían productoId y cantidad; el precio
        e IVA se toman del producto en el servidor.
    FacturaRequest:
      required:
      - items
      type: object
      properties:
        numeroFactura:
          type: string
        clienteId:
          type: string
        cliente:
          $ref: '#/components/schemas/ClienteRequest'
        items:
          type: array
          items:
            $ref: '#/components/schemas/FacturaItemRequest'
        total:
          type: number
          format: double
        realizadoPor:
          type: string
        estado:
          type: string
      description: Solicitud para crear o emitir una factura. Los precios e IVA se
        calculan en el servidor a partir de los productos.
      example:
        items:
        - productoId: 507f1f77bcf86cd799439011
          cantidad: 2
        cliente:
          nombre: Juan Pérez
          documento: '123456789'
          direccion: Calle 123
    ClienteEmbebido:
      type: object
      properties:
        nombre:
          type: string
        documento:
          type: string
        direccion:
          type: string
    Factura:
      type: object
      properties:
        id:
          type: string
        numeroFactura:
          type: string
        prefijo:
          type: string
        resolucionDian:
          type: string
        fechaResolucion:
          type: string
          format: date-time
        rangoAutorizado:
          type: string
        cliente:
          $ref: '#/components/schemas/ClienteEmbebido'
        clienteId:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/FacturaItem'
        subtotal:
          type: number
          format: double
        totalDescuentos:
          type: number
          format: double
        baseImponible:
          type: number
          format: double
        totalIva:
          type: number
          format: double
        total:
          type: number
          format: double
        realizadoPor:
          $ref: '#/components/schemas/ObjectId'
        estado:
          type: string
        creadoEn:
          type: string
          format: date-time
        emitidaEn:
          type: string
          format: date-time
        cufe:
          type: string
        qrCode:
          type: string
        xmlUrl:
          type: string
        pdfUrl:
          type: string
        dianResponse:
          type: string
    FacturaItem:
      type: object
      properties:
        productoId:
          type: string
        nombreProducto:
          type: string
        codigoProducto:
          type: string
        cantidad:
          type: integer
          format: int32
        precioUnitario:
          type: number
          format: double
        descuento:
          type: number
          format: double
        baseImponible:
          type: number
          format: double
        tasaIva:
          type: number
          format: double
        valorIva:
          type: number
          format: double
        subtotal:
          type: number
          format: double
        totalItem:
          type: number
          format: double
    ObjectId:
      type: object
      properties:
        timestamp:
          type: integer
          format: int32
        date:
          type: string
          format: date-time
    ConfiguracionGlobalRequest:
      type: object
      properties:
        tasaIvaPorDefecto:
          type: number
          format: double
        nombreEmpresa:
          type: string
        nit:
          type: string
        digitoVerificacion:
          type: string
        direccion:
          type: string
        telefono:
          type: string
        email:
          type: string
        ciudad:
          type: string
        departamento:
          type: string
        prefijoFactura:
          type: string
        resolucionDian:
          type: string
        fechaResolucionDian:
          type: string
          format: date-time
        rangoFacturaInicio:
          type: integer
          format: int64
        rangoFacturaFin:
          type: integer
          format: int64
    ConfiguracionGlobalResponse:
      type: object
      properties:
        id:
          type: string
        tasaIvaPorDefecto:
          type: number
          format: double
        nombreEmpresa:
          type: string
        nit:
          type: string
        digitoVerificacion:
          type: string
        direccion:
          type: string
        telefono:
          type: string
        email:
          type: string
        ciudad:
          type: string
        departamento:
          type: string
        prefijoFactura:
          type: string
        resolucionDian:
          type: string
        fechaResolucionDian:
          type: string
          format: date-time
        rangoFacturaInicio:
          type: integer
          format: int64
        rangoFacturaFin:
          type: integer
          format: int64
        proximoNumeroFactura:
          type: integer
          format: int64
        actualizadoEn:
          type: string
          format: date-time
    CarritoItemRequest:
      required:
      - cantidad
      - productoId
      type: object
      properties:
        productoId:
          type: string
        cantidad:
          minimum: 1
          type: integer
          format: int32
    CarritoRequest:
      type: object
      properties:
        usuarioId:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/CarritoItemRequest'
        realizadoPor:
          type: string
    RegisterRequest:
      required:
      - apellido
      - email
      - nombre
      - password
      - username
      type: object
      properties:
        username:
          type: string
        email:
          type: string
        password:
          maxLength: 2147483647
          minLength: 8
          type: string
        nombre:
          type: string
        apellido:
          type: string
        inviteCode:
          type: string
    LoginRequest:
      required:
      - password
      - usernameOrEmail
      type: object
      properties:
        usernameOrEmail:
          type: string
        password:
          type: string
        device:
          type: string
    CreateAdminRequest:
      required:
      - apellido
      - email
      - nombre
      - password
      - username
      type: object
      properties:
        username:
          type: string
        email:
          type: string
        password:
          maxLength: 2147483647
          minLength: 8
          type: string
        nombre:
          type: string
        apellido:
          type: string
        roles:
          type: array
          items:
            type: string
        adminKey:
          type: string
  securitySchemes:
    bearerAuth:
      type: http
      description: 'Autenticación con JWT Bearer. Añada el header: Authorization:
        Bearer {token}'
      scheme: bearer
      bearerFormat: JWT
